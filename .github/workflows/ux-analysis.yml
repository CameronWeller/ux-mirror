name: UX-Mirror Analysis

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    paths:
      - '**/*.png'
      - '**/*.jpg'
      - '**/*.jpeg'
      - 'game_screenshots/**'
      - '**/*screenshot*'
  
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to analyze'
        required: false
        type: string

env:
  PYTHON_VERSION: '3.11'

jobs:
  ux-analysis:
    name: üéØ UX Analysis
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      - name: üõí Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: üì¶ Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install python-dotenv fastapi uvicorn PyGithub anthropic
      
      - name: üì∏ Check for Screenshots
        id: check_screenshots
        run: |
          # Look for screenshot files
          screenshots=$(find . -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | grep -E "(screenshot|capture|ui|game_screenshots)" | head -20)
          
          if [ -z "$screenshots" ]; then
            echo "found=false" >> $GITHUB_OUTPUT
            echo "::notice::No screenshots found for UX analysis"
          else
            echo "found=true" >> $GITHUB_OUTPUT
            echo "count=$(echo "$screenshots" | wc -l)" >> $GITHUB_OUTPUT
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$screenshots" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
      
      - name: üîç Run UX Analysis
        if: steps.check_screenshots.outputs.found == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üéØ Running UX analysis on ${{ steps.check_screenshots.outputs.count }} screenshots"
          
          # Create analysis summary
          cat > analysis_summary.md << 'EOF'
          ## üéØ Automated UX Analysis Results
          
          **Analysis Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Screenshots Analyzed**: ${{ steps.check_screenshots.outputs.count }}
          **Workflow**: ${{ github.workflow }}
          **Run ID**: ${{ github.run_id }}
          
          ### üì∏ Screenshots Found:
          ```
          ${{ steps.check_screenshots.outputs.files }}
          ```
          
          ### üìä Analysis Summary
          
          EOF
          
          # Run the temporal screenshot analyzer if we have the API key
          if [ -n "$ANTHROPIC_API_KEY" ]; then
            echo "Running AI-powered visual analysis..."
            python agents/temporal_screenshot_analyzer.py 2>&1 | tee analysis_output.txt
            
            # Check if analysis was successful
            if [ $? -eq 0 ]; then
              echo "‚úÖ Analysis completed successfully" >> analysis_summary.md
              echo "" >> analysis_summary.md
              echo "### ü§ñ AI Analysis Results" >> analysis_summary.md
              echo "" >> analysis_summary.md
              echo "See the generated analysis files for detailed results." >> analysis_summary.md
            else
              echo "‚ö†Ô∏è Analysis completed with warnings" >> analysis_summary.md
              echo "" >> analysis_summary.md
              echo "### ‚ö†Ô∏è Analysis Output" >> analysis_summary.md
              echo "" >> analysis_summary.md
              echo '```' >> analysis_summary.md
              tail -n 20 analysis_output.txt >> analysis_summary.md
              echo '```' >> analysis_summary.md
            fi
          else
            echo "üìä Basic visual analysis (no AI API key provided)" >> analysis_summary.md
            echo "" >> analysis_summary.md
            echo "To enable full AI-powered analysis, add ANTHROPIC_API_KEY to repository secrets." >> analysis_summary.md
          fi
          
          echo "" >> analysis_summary.md
          echo "### üîó Links" >> analysis_summary.md
          echo "- [UX-Mirror Dashboard](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> analysis_summary.md
          echo "- [GitHub Actions Workflow](https://github.com/${{ github.repository }}/actions)" >> analysis_summary.md
          echo "" >> analysis_summary.md
          echo "---" >> analysis_summary.md
          echo "*ü§ñ Generated by UX-Mirror GitHub Actions*" >> analysis_summary.md
      
      - name: üìù Comment on PR
        if: steps.check_screenshots.outputs.found == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read the analysis summary
            let body = '## üéØ UX-Mirror Analysis Report\n\n';
            
            try {
              const summary = fs.readFileSync('analysis_summary.md', 'utf8');
              body += summary;
            } catch (error) {
              body += `‚ö†Ô∏è Error reading analysis summary: ${error.message}\n\n`;
              body += `**Screenshots Found**: ${{ steps.check_screenshots.outputs.count }}\n`;
              body += `**Analysis Status**: Completed with basic checks\n`;
            }
            
            // Post comment on PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
      
      - name: üì§ Upload Analysis Results
        if: steps.check_screenshots.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ux-analysis-results
          path: |
            analysis_summary.md
            analysis_output.txt
            temporal_analysis_*.json
            screenshot_analysis_*.json
          retention-days: 30
      
      - name: üìã Create Issue for Critical Problems
        if: steps.check_screenshots.outputs.found == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            // This is a placeholder for creating issues based on analysis results
            // In a real implementation, you'd parse the analysis results and create issues
            // for critical UX problems detected
            
            const fs = require('fs');
            let analysisFiles = [];
            
            try {
              // Look for analysis result files
              const { execSync } = require('child_process');
              const files = execSync('find . -name "temporal_analysis_*.json" -o -name "screenshot_analysis_*.json"', { encoding: 'utf8' });
              analysisFiles = files.trim().split('\n').filter(f => f);
            } catch (error) {
              console.log('No analysis files found');
              return;
            }
            
            // Process each analysis file
            for (const file of analysisFiles) {
              try {
                const content = fs.readFileSync(file, 'utf8');
                const analysis = JSON.parse(content);
                
                // Check for critical issues (this is a simplified example)
                const hasCriticalIssues = JSON.stringify(analysis).toLowerCase().includes('solid blue') ||
                                         JSON.stringify(analysis).toLowerCase().includes('no visible');
                
                if (hasCriticalIssues) {
                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: `üö® Critical UX Issue Detected in PR #${{ github.event.number }}`,
                    body: `## üö® Critical UX Issue Detected
            
            **Source**: PR #${{ github.event.number }} - ${{ github.event.pull_request.title }}
            **Detected**: ${new Date().toISOString()}
            **Analysis File**: \`${file}\`
            
            ### Problem Description
            Automated analysis detected potential critical UX issues that may impact user experience.
            
            ### Recommendations
            1. Review the visual analysis results in the PR comments
            2. Check screenshot visibility and contrast
            3. Verify that UI elements are properly rendered
            4. Consider manual UX review
            
            ### Analysis Details
            See the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for complete analysis results.
            
            ---
            *ü§ñ Auto-generated by UX-Mirror GitHub Actions*`,
                    labels: ['ux-issue', 'critical-priority', 'auto-generated']
                  });
                  
                  console.log(`Created critical UX issue for analysis file: ${file}`);
                  break; // Only create one issue per PR
                }
              } catch (error) {
                console.log(`Error processing ${file}: ${error.message}`);
              }
            }
      
      - name: ‚ùå No Screenshots Found
        if: steps.check_screenshots.outputs.found == 'false' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## üéØ UX-Mirror Analysis
            
            ### üì∏ No Screenshots Detected
            
            No screenshots were found in this PR. To enable automated UX analysis:
            
            1. **Add screenshots** to the \`game_screenshots/\` directory
            2. **Include visual changes** with descriptive filenames
            3. **Use naming conventions** like \`screenshot_\`, \`ui_\`, or \`capture_\`
            
            ### Manual Analysis Options
            
            If this PR includes visual changes that aren't captured in screenshots:
            
            - Add screenshots manually and push to trigger re-analysis
            - Request manual UX review by adding the \`ux-review\` label
            - Use the workflow dispatch to manually trigger analysis
            
            ---
            *ü§ñ Automated by UX-Mirror GitHub Actions*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
      
      - name: üìä Summary
        run: |
          echo "üéØ UX Analysis Workflow Complete"
          echo "Screenshots found: ${{ steps.check_screenshots.outputs.found }}"
          echo "Screenshots count: ${{ steps.check_screenshots.outputs.count || 0 }}"
          echo "Workflow run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" 